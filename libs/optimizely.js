"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=!0,exports.default=exports.Optimizely=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_qs=_interopRequireDefault(require("qs")),_constants=require("../constants"),_request2=require("./request"),Optimizely=function(){function Optimizely(config){if(!config)throw new Error("Optimizely/Episerver API config required. It is required to make any call to the API");this.site_url=config.site_url,this.response_type=config.response_type,this.headers=config.headers,this.request_timeout=config.request_timeout,this.request_throttle_interval=config.request_throttle_interval,this.request_debounce_interval=config.request_debounce_interval,this.request_concurrency=config.request_concurrency,this.request_max_count=config.request_max_count,this.username=config.username,this.password=config.password,this.grant_type=config.grant_type,this.client_id=config.client_id}var _proto=Optimizely.prototype;return _proto.request=function(){function request(){return _request.apply(this,arguments)}var _request=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee7(url,method,body,headers){var request,_yield$request$run,data,handleExpandKeyValues,handleExpandContentBlocks,expandedData,expandedDataPromise,_this=this;return _regenerator.default.wrap(function(_context7){for(;;)switch(_context7.prev=_context7.next){case 0:return void 0===url&&(url=""),void 0===method&&(method=""),void 0===body&&(body=null),void 0===headers&&(headers={}),request=new _request2.Request(this.site_url,{headers:(0,_extends2.default)({},this.headers,headers),response_type:this.response_type,request_timeout:this.request_timeout,request_throttle_interval:this.request_throttle_interval,request_debounce_interval:this.request_debounce_interval,request_max_count:this.request_max_count}),_context7.next=7,request.run(url,method,body,headers);case 7:if(_yield$request$run=_context7.sent,data=_yield$request$run.data,handleExpandKeyValues=function(){var _ref=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee2(items){var _items,tempItems;return _regenerator.default.wrap(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return void 0===items&&(items=[]),items&&Array.isArray(items)&&0<(null===(_items=items)||void 0===_items?void 0:_items.length)&&(tempItems=(0,_extends2.default)({},items),tempItems.map(function(){var _ref2=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee(item){var _tempItem,_tempItem$contentLink,tempItem,_yield$request$run2,expandedData;return _regenerator.default.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(void 0===item&&(item={}),tempItem=(0,_extends2.default)({},item),"number"!=typeof(null===(_tempItem=tempItem)||void 0===_tempItem||null===(_tempItem$contentLink=_tempItem.contentLink)||void 0===_tempItem$contentLink?void 0:_tempItem$contentLink.id)){_context.next=8;break}return _context.next=5,request.run(""+(_this.site_url+_constants.CONTENT_ENDPOINT+tempItem.contentLink.id+"&expand=*"),"get");case 5:_yield$request$run2=_context.sent,expandedData=_yield$request$run2.data,expandedData&&Array.isArray(expandedData)&&0<(null===expandedData||void 0===expandedData?void 0:expandedData.length)&&(tempItem=(0,_extends2.default)({},tempItem,expandedData[0]));case 8:return _context.abrupt("return",tempItem);case 9:case"end":return _context.stop();}},_callee)}));return function(){return _ref2.apply(this,arguments)}}())),_context2.abrupt("return",items);case 3:case"end":return _context2.stop();}},_callee2)}));return function(){return _ref.apply(this,arguments)}}(),handleExpandContentBlocks=function(){var _ref3=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee5(blocks){var _blocks;return _regenerator.default.wrap(function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:return void 0===blocks&&(blocks=[]),blocks&&Array.isArray(blocks)&&0<(null===(_blocks=blocks)||void 0===_blocks?void 0:_blocks.length)&&blocks.map(function(){var _ref4=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee4(block){var _tempBlock$contentLin,_tempBlock$contentLin2,_tempBlock$contentLin3,_tempBlock$contentLin4,_tempBlock$contentLin5,_tempBlock$contentLin6,_tempBlock$contentLin7,_tempBlock$contentLin8,_tempBlock$contentLin9,_tempBlock$contentLin10,_tempBlock$contentLin11,_tempBlock$contentLin12,_tempBlock$contentLin13,_tempBlock$contentLin14,_tempBlock$contentLin15,_tempBlock$contentLin16,_tempBlock$contentLin17,_tempBlock$contentLin18,_tempBlock$contentLin19,_tempBlock$contentLin20,_tempBlock$contentLin21,_tempBlock$contentLin22,_tempBlock$contentLin23,_tempBlock$contentLin24,_tempBlock$contentLin25,_tempBlock$contentLin26,_tempBlock$contentLin27,_tempBlock$contentLin28,tempBlock,dynamicStylesPromise,itemsPromise,imagesPromise,formPromise,expandedKeyValuesPromises;return _regenerator.default.wrap(function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:if(void 0===block&&(block={}),tempBlock=(0,_extends2.default)({},block),!(null!==(_tempBlock$contentLin=tempBlock.contentLink)&&void 0!==_tempBlock$contentLin&&null!==(_tempBlock$contentLin2=_tempBlock$contentLin.expanded)&&void 0!==_tempBlock$contentLin2&&_tempBlock$contentLin2.dynamicStyles&&Array.isArray(null===(_tempBlock$contentLin3=tempBlock.contentLink)||void 0===_tempBlock$contentLin3||null===(_tempBlock$contentLin4=_tempBlock$contentLin3.expanded)||void 0===_tempBlock$contentLin4?void 0:_tempBlock$contentLin4.dynamicStyles)&&0<(null===(_tempBlock$contentLin5=tempBlock.contentLink)||void 0===_tempBlock$contentLin5||null===(_tempBlock$contentLin6=_tempBlock$contentLin5.expanded)||void 0===_tempBlock$contentLin6||null===(_tempBlock$contentLin7=_tempBlock$contentLin6.dynamicStyles)||void 0===_tempBlock$contentLin7?void 0:_tempBlock$contentLin7.length))){_context4.next=8;break}return _context4.next=5,handleExpandKeyValues(tempBlock.contentLink.expanded.dynamicStyles);case 5:_context4.t0=_context4.sent,_context4.next=9;break;case 8:_context4.t0=null;case 9:if(dynamicStylesPromise=_context4.t0,!(null!==(_tempBlock$contentLin8=tempBlock.contentLink)&&void 0!==_tempBlock$contentLin8&&null!==(_tempBlock$contentLin9=_tempBlock$contentLin8.expanded)&&void 0!==_tempBlock$contentLin9&&_tempBlock$contentLin9.items&&Array.isArray(null===(_tempBlock$contentLin10=tempBlock.contentLink)||void 0===_tempBlock$contentLin10||null===(_tempBlock$contentLin11=_tempBlock$contentLin10.expanded)||void 0===_tempBlock$contentLin11?void 0:_tempBlock$contentLin11.items)&&0<(null===(_tempBlock$contentLin12=tempBlock.contentLink)||void 0===_tempBlock$contentLin12||null===(_tempBlock$contentLin13=_tempBlock$contentLin12.expanded)||void 0===_tempBlock$contentLin13||null===(_tempBlock$contentLin14=_tempBlock$contentLin13.items)||void 0===_tempBlock$contentLin14?void 0:_tempBlock$contentLin14.length))){_context4.next=16;break}return _context4.next=13,handleExpandKeyValues(tempBlock.contentLink.expanded.items);case 13:_context4.t1=_context4.sent,_context4.next=17;break;case 16:_context4.t1=null;case 17:if(itemsPromise=_context4.t1,!(null!==(_tempBlock$contentLin15=tempBlock.contentLink)&&void 0!==_tempBlock$contentLin15&&null!==(_tempBlock$contentLin16=_tempBlock$contentLin15.expanded)&&void 0!==_tempBlock$contentLin16&&_tempBlock$contentLin16.images&&Array.isArray(null===(_tempBlock$contentLin17=tempBlock.contentLink)||void 0===_tempBlock$contentLin17||null===(_tempBlock$contentLin18=_tempBlock$contentLin17.expanded)||void 0===_tempBlock$contentLin18?void 0:_tempBlock$contentLin18.images)&&0<(null===(_tempBlock$contentLin19=tempBlock.contentLink)||void 0===_tempBlock$contentLin19||null===(_tempBlock$contentLin20=_tempBlock$contentLin19.expanded)||void 0===_tempBlock$contentLin20||null===(_tempBlock$contentLin21=_tempBlock$contentLin20.images)||void 0===_tempBlock$contentLin21?void 0:_tempBlock$contentLin21.length))){_context4.next=24;break}return _context4.next=21,handleExpandKeyValues(tempBlock.contentLink.expanded.images);case 21:_context4.t2=_context4.sent,_context4.next=25;break;case 24:_context4.t2=null;case 25:if(imagesPromise=_context4.t2,!(null!==(_tempBlock$contentLin22=tempBlock.contentLink)&&void 0!==_tempBlock$contentLin22&&null!==(_tempBlock$contentLin23=_tempBlock$contentLin22.expanded)&&void 0!==_tempBlock$contentLin23&&_tempBlock$contentLin23.form&&Array.isArray(null===(_tempBlock$contentLin24=tempBlock.contentLink)||void 0===_tempBlock$contentLin24||null===(_tempBlock$contentLin25=_tempBlock$contentLin24.expanded)||void 0===_tempBlock$contentLin25?void 0:_tempBlock$contentLin25.form)&&0<(null===(_tempBlock$contentLin26=tempBlock.contentLink)||void 0===_tempBlock$contentLin26||null===(_tempBlock$contentLin27=_tempBlock$contentLin26.expanded)||void 0===_tempBlock$contentLin27||null===(_tempBlock$contentLin28=_tempBlock$contentLin27.form)||void 0===_tempBlock$contentLin28?void 0:_tempBlock$contentLin28.length))){_context4.next=32;break}return _context4.next=29,handleExpandKeyValues(tempBlock.contentLink.expanded.form);case 29:_context4.t3=_context4.sent,_context4.next=33;break;case 32:_context4.t3=null;case 33:return formPromise=_context4.t3,expandedKeyValuesPromises=[dynamicStylesPromise,itemsPromise,imagesPromise,formPromise],_context4.next=37,Promise.allSettled(expandedKeyValuesPromises).then(function(res){return res&&Array.isArray(res)&&0<(null===res||void 0===res?void 0:res.length)?res.filter(function(item){return"fulfilled"===(null===item||void 0===item?void 0:item.status)}).map(function(){var _ref5=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee3(item,index){return _regenerator.default.wrap(function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:_context3.t0=index,_context3.next=0===_context3.t0?3:1===_context3.t0?7:2===_context3.t0?9:3===_context3.t0?11:13;break;case 3:if(null===(null===item||void 0===item?void 0:item.value)){_context3.next=6;break}return _context3.next=6,Promise.allSettled(null===item||void 0===item?void 0:item.value).then(function(res){return Promise.resolve(res)}).catch(function(err){return Promise.reject(err)});case 6:return _context3.abrupt("return");case 7:return tempBlock.contentLink.expanded.items=[].concat(tempBlock.contentLink.expanded.items,item),_context3.abrupt("break",14);case 9:return tempBlock.contentLink.expanded.images=[].concat(tempBlock.contentLink.expanded.images,item),_context3.abrupt("break",14);case 11:return tempBlock.contentLink.expanded.form=[].concat(tempBlock.contentLink.expanded.form,item),_context3.abrupt("break",14);case 13:return _context3.abrupt("break",14);case 14:return _context3.abrupt("return",Promise.resolve(tempBlock));case 15:case"end":return _context3.stop();}},_callee3)}));return function(){return _ref5.apply(this,arguments)}}()):null}).catch(function(err){return Promise.reject(err)});case 37:return _context4.abrupt("return",tempBlock);case 38:case"end":return _context4.stop();}},_callee4)}));return function(){return _ref4.apply(this,arguments)}}()),_context5.abrupt("return",blocks);case 3:case"end":return _context5.stop();}},_callee5)}));return function(){return _ref3.apply(this,arguments)}}(),!(data&&Array.isArray(data)&&0<(null===data||void 0===data?void 0:data.length))){_context7.next=18;break}return _context7.next=14,Promise.allSettled(data.map(function(){var _ref6=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee6(item){var tempItem,_tempItem$contentBloc,contentBlocks,_tempItem$contentBloc2,contentBlocksTop,_tempItem$contentBloc3,contentBlocksBottom,expandedContentBlocks,expandedContentBlocksTop,expandedContentBlocksBottom;return _regenerator.default.wrap(function(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:if(tempItem=(0,_extends2.default)({},item),_tempItem$contentBloc=tempItem.contentBlocks,contentBlocks=void 0===_tempItem$contentBloc?null:_tempItem$contentBloc,_tempItem$contentBloc2=tempItem.contentBlocksTop,contentBlocksTop=void 0===_tempItem$contentBloc2?null:_tempItem$contentBloc2,_tempItem$contentBloc3=tempItem.contentBlocksBottom,contentBlocksBottom=void 0===_tempItem$contentBloc3?null:_tempItem$contentBloc3,!(contentBlocks&&Array.isArray(contentBlocks)&&0<(null===contentBlocks||void 0===contentBlocks?void 0:contentBlocks.length))){_context6.next=7;break}return _context6.next=5,handleExpandContentBlocks(contentBlocks);case 5:expandedContentBlocks=_context6.sent,tempItem.contentBlocks=expandedContentBlocks;case 7:if(!(contentBlocksTop&&Array.isArray(contentBlocksTop)&&0<(null===contentBlocksTop||void 0===contentBlocksTop?void 0:contentBlocksTop.length))){_context6.next=12;break}return _context6.next=10,handleExpandContentBlocks(contentBlocksTop);case 10:expandedContentBlocksTop=_context6.sent,tempItem.contentBlocksTop=expandedContentBlocksTop;case 12:if(!(contentBlocksBottom&&Array.isArray(contentBlocksBottom)&&0<(null===contentBlocksBottom||void 0===contentBlocksBottom?void 0:contentBlocksBottom.length))){_context6.next=17;break}return _context6.next=15,handleExpandContentBlocks(contentBlocksBottom);case 15:expandedContentBlocksBottom=_context6.sent,tempItem.contentBlocksBottom=expandedContentBlocksBottom;case 17:return _context6.abrupt("return",tempItem);case 18:case"end":return _context6.stop();}},_callee6)}));return function(){return _ref6.apply(this,arguments)}}())).then(function(res){var _res$filter;return Promise.resolve(null===res||void 0===res||null===(_res$filter=res.filter(function(item){return"fulfilled"===(null===item||void 0===item?void 0:item.status)}))||void 0===_res$filter?void 0:_res$filter.map(function(item){return null===item||void 0===item?void 0:item.value}))}).catch(function(err){return Promise.reject(err)});case 14:return expandedData=_context7.sent,_context7.abrupt("return",expandedData);case 18:if(!(data&&"[object Object]"===Object.prototype.toString.call(data)&&0<Object.keys(data).length)){_context7.next=29;break}return _context7.prev=19,expandedDataPromise=new Promise(function(resolve,reject){var tempItem=(0,_extends2.default)({},data),_tempItem$contentBloc4=tempItem.contentBlocks,contentBlocks=void 0===_tempItem$contentBloc4?null:_tempItem$contentBloc4,_tempItem$contentBloc5=tempItem.contentBlocksTop,contentBlocksTop=void 0===_tempItem$contentBloc5?null:_tempItem$contentBloc5,_tempItem$contentBloc6=tempItem.contentBlocksBottom,contentBlocksBottom=void 0===_tempItem$contentBloc6?null:_tempItem$contentBloc6;if(contentBlocks&&Array.isArray(contentBlocks)&&0<(null===contentBlocks||void 0===contentBlocks?void 0:contentBlocks.length)){var expandedContentBlocks=handleExpandContentBlocks(contentBlocks);tempItem.contentBlocks=expandedContentBlocks}if(contentBlocksTop&&Array.isArray(contentBlocksTop)&&0<(null===contentBlocksTop||void 0===contentBlocksTop?void 0:contentBlocksTop.length)){var expandedContentBlocksTop=handleExpandContentBlocks(contentBlocksTop);tempItem.contentBlocksTop=expandedContentBlocksTop}if(contentBlocksBottom&&Array.isArray(contentBlocksBottom)&&0<(null===contentBlocksBottom||void 0===contentBlocksBottom?void 0:contentBlocksBottom.length)){var expandedContentBlocksBottom=handleExpandContentBlocks(contentBlocksBottom);tempItem.contentBlocksBottom=expandedContentBlocksBottom}return tempItem?resolve(tempItem):reject(tempItem)}),_context7.abrupt("return",expandedDataPromise);case 24:return _context7.prev=24,_context7.t0=_context7["catch"](19),_context7.abrupt("return",Promise.reject(_context7.t0));case 27:_context7.next=30;break;case 29:return _context7.abrupt("return",data);case 30:case"end":return _context7.stop();}},_callee7,this,[[19,24]])}));return request}(),_proto.get=function(){function get(){return _get.apply(this,arguments)}var _get=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee8(_ref7){var _ref7$url,url,_ref7$body,body,_ref7$headers,headers;return _regenerator.default.wrap(function(_context8){for(;;)switch(_context8.prev=_context8.next){case 0:return _ref7$url=_ref7.url,url=void 0===_ref7$url?"":_ref7$url,_ref7$body=_ref7.body,body=void 0===_ref7$body?null:_ref7$body,_ref7$headers=_ref7.headers,headers=void 0===_ref7$headers?{}:_ref7$headers,_context8.next=3,this.request(url,"get",body,headers).then(function(res){return res}).catch(function(err){return err});case 3:case"end":return _context8.stop();}},_callee8,this)}));return get}(),_proto.post=function(){function post(){return _post.apply(this,arguments)}var _post=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee9(_ref8){var _ref8$url,url,_ref8$body,body,_ref8$headers,headers;return _regenerator.default.wrap(function(_context9){for(;;)switch(_context9.prev=_context9.next){case 0:return _ref8$url=_ref8.url,url=void 0===_ref8$url?"":_ref8$url,_ref8$body=_ref8.body,body=void 0===_ref8$body?null:_ref8$body,_ref8$headers=_ref8.headers,headers=void 0===_ref8$headers?{}:_ref8$headers,_context9.next=3,this.request(url,"post",body,headers).then(function(res){return res}).catch(function(err){return err});case 3:case"end":return _context9.stop();}},_callee9,this)}));return post}(),_proto.authenticate=function(){function authenticate(){return _authenticate.apply(this,arguments)}var _authenticate=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee10(){var config;return _regenerator.default.wrap(function(_context10){for(;;)switch(_context10.prev=_context10.next){case 0:return config={url:this.site_url+_constants.REQUEST_URL_SLUG+_constants.AUTH_ENDPOINT,data:_qs.default.stringify({username:this.username,password:this.password,grant_type:this.grant_type,client_id:this.client_id},{encode:!1}),headers:{Accept:_constants.REQUEST_ACCEPT_HEADER,"Content-Type":_constants.AUTH_REQUEST_CONTENT_TYPE_HEADER}},_context10.next=3,this.post({url:config.url,body:config.data,headers:config.headers});case 3:case"end":return _context10.stop();}},_callee10,this)}));return authenticate}(),Optimizely}();exports.Optimizely=Optimizely;var _default=Optimizely;exports.default=_default;
//# sourceMappingURL=optimizely.js.map